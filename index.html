<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System_OS | Garden Control</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-green: #2ecc71;
            --glow-green: rgba(46, 204, 113, 0.4);
            --dark-bg: #050505;
            --glass-bg: rgba(5, 5, 5, 0.95);
        }

        body, html {
            margin: 0; padding: 0; height: 100%;
            background-color: var(--dark-bg);
            color: #fff; font-family: 'Courier New', monospace;
            overflow: hidden;
        }

        /* --- BACKGROUND LAYER --- */
        .gallery-container {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex; z-index: 1;
            padding-left: 8vw;
            box-sizing: border-box;
            transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .blurred { filter: blur(10px) brightness(0.3); transform: scale(1.05); }

        .gallery-col { flex: 1; height: 100%; perspective: 1000px; border-right: 1px solid rgba(46, 204, 113, 0.1); }
        .flip-card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.4s; transform-style: preserve-3d; }
        .gallery-col:hover .flip-card-inner { transform: rotateY(180deg); }
        .flip-front, .flip-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .flip-front { background-color: #000; }
        .flip-back { background-color: rgba(0, 20, 0, 0.9); color: var(--primary-green); transform: rotateY(180deg); padding: 20px; flex-direction: column; border: 1px solid var(--primary-green); }
        .flip-front img { width: 100%; height: 100%; object-fit: cover; opacity: 0.4; transition: 0.5s; }
        .gallery-col:hover .flip-front img { opacity: 0.8; }

        /* --- SIDEBAR --- */
        .sidebar {
            position: absolute; left: 0; top: 0; height: 100vh; width: 8vw;
            background: var(--glass-bg); backdrop-filter: blur(20px);
            border-right: 1px solid var(--primary-green);
            display: flex; flex-direction: column; justify-content: space-between; align-items: center;
            z-index: 100; transition: width 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            padding: 40px 0; box-sizing: border-box;
        }

        .sidebar:hover { width: 35vw; }

        /* Dashboard State for Sidebar */
        .sidebar.active-dash { width: 20vw !important; border-right: 1px solid var(--primary-green); background: #000; }

        .vertical-label { writing-mode: vertical-rl; text-orientation: mixed; color: var(--primary-green); font-size: 24px; letter-spacing: 5px; text-transform: uppercase; font-weight: bold; transition: opacity 0.3s; }
        .sidebar:hover .vertical-label, .sidebar.active-dash .vertical-label { opacity: 0; display: none; }

        /* --- CONTAINERS --- */
        .auth-container, .dash-info-container {
            display: flex; flex-direction: column; width: 80%; max-width: 300px;
            opacity: 0; transform: translateX(-20px); transition: 0.3s; pointer-events: none;
        }

        .sidebar:hover .auth-container, .sidebar.active-dash .dash-info-container {
            opacity: 1; transform: translateX(0); pointer-events: auto; transition-delay: 0.2s;
        }

        /* --- CENTRAL DASHBOARD BOX --- */
        .central-hub {
            position: fixed; top: 50%; left: 55%; transform: translate(-50%, -50%) scale(0.9);
            width: 450px; background: rgba(0,0,0,0.9); border: 1px solid var(--primary-green);
            padding: 40px; z-index: 150; opacity: 0; pointer-events: none;
            transition: all 0.5s ease; box-shadow: 0 0 40px var(--glow-green);
        }

        .central-hub.active { opacity: 1; transform: translate(-50%, -50%) scale(1); pointer-events: auto; }

        /* --- BUTTONS & INPUTS --- */
        h2, h3 { color: var(--primary-green); letter-spacing: 4px; text-align: center; text-transform: uppercase; }
        input { background: #000; border: 1px solid #333; padding: 15px; margin-bottom: 15px; color: var(--primary-green); outline: none; width: 100%; box-sizing: border-box; transition: 0.3s; }
        input:focus { border-color: var(--primary-green); box-shadow: 0 0 10px var(--glow-green); }
        
        .btn-main { 
            background: transparent; border: 1px solid var(--primary-green); color: var(--primary-green); 
            padding: 15px; font-weight: bold; cursor: pointer; text-transform: uppercase; 
            transition: all 0.3s ease; width: 100%; 
        }
        .btn-main:hover { background: var(--primary-green); color: #000; box-shadow: 0 0 20px var(--primary-green); }

        .btn-signup { background: #000; border-radius: 4px; border: 1px solid var(--primary-green); color: var(--primary-green); padding: 10px 25px; cursor: pointer; transition: 0.3s; }
        .btn-signup:hover { background: var(--primary-green); color: #000; }

        .device-list-item { background: rgba(46, 204, 113, 0.05); padding: 10px; margin-top: 10px; border-left: 3px solid var(--primary-green); font-size: 0.8em; }

        .hidden { display: none !important; }
        .top-nav { position: absolute; top: 30px; right: 40px; z-index: 200; }

/* --- DASHBOARD HEADER (Hidden by default) --- */
#dash-side-content {
    display: none; /* Absolute hidden state for login page */
}

/* --- MOBILE REFACTORED LAYOUT --- */
@media (max-width: 768px) {
    /* 1. Force the auth container to be visible immediately on mobile */
    .auth-container {
        opacity: 1 !important;
        transform: translateX(0) !important;
        pointer-events: auto !important;
        position: relative; /* Centers it better within the flex sidebar */
        display: flex !important;
    }

    /* 2. Ensure the sidebar (which contains the form) is visible */
    .sidebar {
        width: 100vw !important;
        background: rgba(0, 0, 0, 0.85); /* Slightly darker for better readability */
        display: flex !important;
        justify-content: center;
        align-items: center;
    }

    /* 3. Hide the vertical 'LOG IN' label on mobile to avoid clutter */
    .vertical-label {
        display: none !important;
    }
}
    /* Login Sidebar */
    .sidebar {
        width: 100vw !important;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(15px);
        z-index: 1000;
    }

    /* Hide Sidebar completely after login */
    .sidebar.active-dash {
        display: none !important;
    }

    /* The Mobile Top Bar (Only visible when active) */
    .dash-info-container.active-mobile-bar {
        display: flex !important;
        position: fixed;
        top: 0; left: 0;
        width: 100%;
        height: 80px;
        background: #000;
        border-bottom: 1px solid var(--primary-green);
        justify-content: space-between;
        align-items: center;
        padding: 0 20px;
        box-sizing: border-box;
        z-index: 1100;
    }

    /* Left Side: User Info Stack */
    .user-info-stack {
        display: flex;
        flex-direction: column;
        text-align: left;
    }

    .user-info-stack h3 {
        font-size: 1rem;
        margin: 0;
        color: white;
        text-align: left;
    }

    .user-info-stack p {
        font-size: 0.7rem;
        margin: 2px 0 0 0;
        color: var(--primary-green);
        opacity: 0.8;
    }

    /* Right Side: Compact Disconnect Button */
    .dash-info-container .btn-disconnect {
        width: auto !important;
        padding: 8px 12px;
        font-size: 0.7rem;
        border: 1px solid #e74c3c;
        color: #e74c3c;
        background: transparent;
        text-transform: uppercase;
        font-weight: bold;
    }
}
    </style>
</head>
<body>

    <div class="sidebar" id="main-sidebar">
        <div class="vertical-label" id="side-label">SYSTEM ACCESS</div>

        <div class="auth-container" id="auth-box">
            <h2>LOGIN</h2>
            <input type="email" id="email" placeholder="USER_ID">
            <input type="password" id="password" placeholder="ACCESS_KEY">
            <button class="btn-main" onclick="handleAuth()">Authorize</button>
        </div>

<div class="dash-info-container hidden" id="dash-side-content">
    <div class="user-info-stack">
        <h3 id="user-display-name">USER</h3>
        <p id="user-display-email">email@system.com</p>
    </div>
    <button class="btn-main" onclick="location.reload()">Disconnect</button>
</div>
    </div>

    <div class="central-hub" id="hardware-hub">
        <h3>Hardware Management</h3>
        <p style="font-size: 0.7em; color: #666; margin-bottom: 25px;">REGISTER NEW ESP32 NODE</p>
        <input type="text" id="mac-address" placeholder="MAC_ADDRESS (XX:XX:XX)">
        <button class="btn-main" onclick="registerDevice()">Link Hardware</button>
        
        <div style="margin-top: 30px; text-align: left;">
            <p style="font-size: 0.8em; border-bottom: 1px solid #333; padding-bottom: 5px;">ACTIVE_DEVICES</p>
            <div id="device-list"></div>
        </div>
    </div>

    <div class="gallery-container" id="gallery">
        <div class="gallery-col"><div class="flip-card-inner"><div class="flip-front"><img src="https://i.ibb.co/g1WSXWH/pexels-zimak-18393763.jpg"></div><div class="flip-back"><h3>FUTURE</h3><p>Root Access</p></div></div></div>
        <div class="gallery-col"><div class="flip-card-inner"><div class="flip-front"><img src="https://i.ibb.co/wNQRqcLf/pexels-cjanimus-20261506.jpg"></div><div class="flip-back"><h3>SMART</h3><p>Irrigation</p></div></div></div>
        <div class="gallery-col"><div class="flip-card-inner"><div class="flip-front"><img src="https://i.ibb.co/Lzhj4fyG/pexels-doma-18248912.jpg"></div><div class="flip-back"><h3>MODERN</h3><p>Botany</p></div></div></div>
        <div class="gallery-col"><div class="flip-card-inner"><div class="flip-front"><img src="https://i.ibb.co/5gWj605y/pexels-elias-tigiser-411757-5652089.jpg"></div><div class="flip-back"><h3>ANALYSIS</h3><p>Live Metrics</p></div></div></div>
        <div class="gallery-col"><div class="flip-card-inner"><div class="flip-front"><img src="https://i.ibb.co/k2yVDmbh/pexels-mikhail-nilov-6965514.jpg"></div><div class="flip-back"><h3>SYSTEM</h3><p>Connected</p></div></div></div>
        <div class="gallery-col"><div class="flip-card-inner"><div class="flip-front"><img src="https://i.ibb.co/MD432Gtx/pexels-alexander-hohn-2153656687-33217919.jpg"></div><div class="flip-back"><h3>PLANT</h3><p>Health</p></div></div></div>
    </div>

    <div class="top-nav" id="signup-nav">
        <button class="btn-signup" onclick="toggleAuthMode()">Sign Up</button>
    </div>

    <script>
        const SB_URL = "https://ccvtugkkhweprgtupwqb.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNjdnR1Z2traHdlcHJndHVwd3FiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzOTcyMjAsImV4cCI6MjA4NTk3MzIyMH0.zZ_5Dx8txWOFfrYj0QIKu3v5Pp4Q7EMYdHGzxUalcQ4";
        const _supabase = supabase.createClient(SB_URL, SB_KEY);
        let isSignUpMode = false;

        window.toggleAuthMode = function() {
            isSignUpMode = !isSignUpMode;
            document.querySelector('h2').innerText = isSignUpMode ? "CREATE_USER" : "SYSTEM_LOGIN";
            document.querySelector('.btn-signup').innerText = isSignUpMode ? "Back to Login" : "Sign Up";
        };

        window.handleAuth = async function() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            if (isSignUpMode) {
                const { data, error } = await _supabase.auth.signUp({ email, password });
                if (error) alert("ERR: " + error.message);
                else alert("Success! You can now log in.");
            } else {
                const { data, error } = await _supabase.auth.signInWithPassword({ email, password });
                if (error) alert("ACCESS_DENIED: " + error.message);
                else showUI(data.user);
            }
        };

function showUI(user) {
    // Hide the login elements
    document.getElementById('auth-box').style.display = 'none';
    document.getElementById('signup-nav').style.display = 'none';
    
    // Set user info
    document.getElementById('user-display-name').innerText = user.email.split('@')[0].toUpperCase();
    document.getElementById('user-display-email').innerText = user.email;

    const sidebar = document.getElementById('main-sidebar');
    const dashSide = document.getElementById('dash-side-content');

    if (window.innerWidth <= 768) {
        // Force the sidebar to disappear on mobile
        sidebar.style.display = 'none';
        // Move the dashboard header to the top of the screen
        document.body.appendChild(dashSide);
        dashSide.classList.add('active-mobile-bar');
    } else {
        sidebar.classList.add('active-dash');
        dashSide.classList.remove('hidden');
    }

    // Activate the main hub
    document.getElementById('gallery').classList.add('blurred');
    document.getElementById('hardware-hub').classList.add('active');
    
    loadDevices();
}

        window.registerDevice = async function() {
            const mac = document.getElementById('mac-address').value;
            if(!mac) return;
            const { data: { user } } = await _supabase.auth.getUser();
            const { error } = await _supabase.from('devices').insert([{ device_id: mac, owner_id: user.id, active_seed_id: 1 }]);
            if (error) alert("REG_ERR: " + error.message);
            else { 
                document.getElementById('mac-address').value = "";
                loadDevices(); 
            }
        };

        async function loadDevices() {
            const { data, error } = await _supabase.from('devices').select('*');
            if (!error && data) {
                document.getElementById('device-list').innerHTML = data.map(d => `
                    <div class="device-list-item">
                        ID: ${d.device_id} | <span style="color:var(--primary-green)">${d.current_moisture || 0}% MOISTURE</span>
                    </div>
                `).join('');
            }
        }
    </script>
</body>
</html>
