<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System_OS | Garden Control</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-green: #2ecc71;
            --dark-bg: #050505;
            --glass-bg: rgba(5, 5, 5, 0.9);
        }

        body, html {
            margin: 0; padding: 0; height: 100%;
            background-color: var(--dark-bg);
            color: #fff; font-family: 'Courier New', monospace;
            overflow: hidden;
        }

        /* --- BACKGROUND GALLERY --- */
        .gallery-container {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex; z-index: 1;
            padding-left: 8vw;
            box-sizing: border-box;
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .blurred { filter: blur(8px) brightness(0.35); }

        .gallery-col { flex: 1; height: 100%; perspective: 1000px; border-right: 1px solid rgba(46, 204, 113, 0.1); }
        .flip-card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.4s; transform-style: preserve-3d; }
        .gallery-col:hover .flip-card-inner { transform: rotateY(180deg); }
        .flip-front, .flip-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .flip-front { background-color: #000; }
        .flip-back { background-color: rgba(0, 15, 0, 0.95); color: var(--primary-green); transform: rotateY(180deg); padding: 20px; flex-direction: column; border: 1px solid var(--primary-green); text-align: center;}
        .flip-front img { width: 100%; height: 100%; object-fit: cover; opacity: 0.5; }

        /* --- SIDEBAR --- */
        .sidebar {
            position: fixed; left: 0; top: 0; height: 100vh;
            width: 8vw; background: var(--glass-bg); backdrop-filter: blur(20px);
            border-right: 1px solid var(--primary-green);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 1000; transition: width 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            overflow: hidden;
        }
        .sidebar:hover, .sidebar.locked { width: 35vw; }

        .vertical-label { 
            writing-mode: vertical-rl; text-orientation: mixed; color: var(--primary-green); 
            font-size: 24px; letter-spacing: 5px; font-weight: bold; transition: 0.3s;
        }
        .sidebar:hover .vertical-label, .sidebar.locked .vertical-label { opacity: 0; }

        .auth-container {
            opacity: 0; transform: translateX(-20px); transition: 0.4s; pointer-events: none;
            width: 80%; max-width: 300px; position: absolute; display: flex; flex-direction: column;
        }
        .sidebar:hover .auth-container, .sidebar.locked .auth-container { opacity: 1; transform: translateX(0); pointer-events: auto; }

        /* --- DASHBOARD HEADER --- */
        .dash-info-container { 
            display: none; position: absolute; top: 40px; left: 40px; text-align: left;
        }
        .user-info-stack h3 { font-size: 1.2rem; margin: 0; color: #fff; }
        .user-info-stack p { font-size: 0.8rem; margin: 5px 0 15px 0; color: var(--primary-green); opacity: 0.8; word-break: break-all; }

        /* --- NODES HUB (Size Adjusted) --- */
        .central-hub {
            position: fixed; top: 50%; left: 55%; transform: translate(-50%, -50%) scale(0.9);
            width: 90%; max-width: 400px; /* Reduced width */
            max-height: 80vh; overflow-y: auto; /* Prevent vertical overflow */
            background: rgba(0,0,0,0.95); border: 1px solid var(--primary-green);
            padding: 30px; z-index: 150; opacity: 0; pointer-events: none;
            transition: all 0.5s ease; box-shadow: 0 0 30px rgba(46, 204, 113, 0.15);
        }
        .central-hub.active { opacity: 1; transform: translate(-50%, -50%) scale(1); pointer-events: auto; }

        /* --- UI ELEMENTS --- */
        input { background: #000; border: 1px solid #333; padding: 15px; margin-bottom: 15px; color: var(--primary-green); outline: none; width: 100%; box-sizing: border-box; transition: 0.3s; }
        input:focus { border-color: var(--primary-green); box-shadow: 0 0 10px rgba(46, 204, 113, 0.3); }

        .btn-main { background: transparent; border: 1px solid var(--primary-green); color: var(--primary-green); padding: 15px; font-weight: bold; cursor: pointer; text-transform: uppercase; width: 100%; transition: 0.3s; }
        .btn-main:hover { background: var(--primary-green); color: #000; }
        
        .btn-disconnect { width: auto !important; padding: 8px 20px !important; border-color: #e74c3c !important; color: #e74c3c !important; margin-top: 10px; }
        .btn-disconnect:hover { background: #e74c3c !important; color: #fff !important; }

        .top-nav { position: absolute; top: 30px; right: 40px; z-index: 2000; }
        .btn-signup { background: #000; border: 1px solid var(--primary-green); color: var(--primary-green); padding: 10px 25px; cursor: pointer; border-radius: 4px; }
        .device-item { background: rgba(255,255,255,0.05); padding: 12px; margin-top: 10px; border-left: 2px solid var(--primary-green); font-size: 0.85em; display: flex; justify-content: space-between;}

        .hidden { display: none !important; }

        /* --- MOBILE OVERRIDES --- */
        @media (max-width: 768px) {
            .sidebar { width: 100vw; background: rgba(0,0,0,0.85); border-right: none; }
            .sidebar:hover, .sidebar.locked { width: 100vw; }
            .vertical-label { display: none; }
            .auth-container { opacity: 1; transform: none; pointer-events: auto; position: relative; }
            .gallery-container { padding-left: 0; }
            .central-hub { width: 92vw; left: 50% !important; top: 55% !important; max-width: none; }
            .active-mobile-bar {
                display: block !important; position: fixed; top: 0; left: 0; width: 100vw; height: auto;
                background: #000; border-bottom: 1px solid var(--primary-green);
                z-index: 3000; padding: 20px; box-sizing: border-box;
            }
        }
    </style>
</head>
<body>

    <div class="top-nav" id="signup-nav">
        <button class="btn-signup" onclick="toggleAuthMode()">Sign Up</button>
    </div>

    <div class="sidebar" id="main-sidebar">
        <div class="vertical-label">SYSTEM LOGIN</div>
        <div class="auth-container" id="auth-box">
            <h2 id="auth-title">LOGIN</h2>
            <input type="email" id="email" placeholder="USER_ID" onfocus="lockSidebar(true)" onblur="lockSidebar(false)">
            <input type="password" id="password" placeholder="ACCESS_KEY" onfocus="lockSidebar(true)" onblur="lockSidebar(false)">
            <button class="btn-main" onclick="handleAuth()">Authorize</button>
        </div>

        <div class="dash-info-container" id="dash-side-content">
            <div class="user-info-stack">
                <h3 id="user-display-name">USER</h3>
                <p id="user-display-email"></p>
                <button class="btn-main btn-disconnect" onclick="location.reload()">Disconnect</button>
            </div>
        </div>
    </div>

    <div class="central-hub" id="hardware-hub">
        <h3>Node Management</h3>
        <input type="text" id="mac-address" placeholder="MAC_ADDR (XX:XX:XX)">
        <button class="btn-main" onclick="registerDevice()">Link Node</button>
        <div id="device-list" style="margin-top: 20px;"></div>
    </div>

    <div class="gallery-container" id="gallery">
        <div class="gallery-col"><div class="flip-card-inner"><div class="flip-front"><img src="https://i.ibb.co/g1WSXWH/pexels-zimak-18393763.jpg"></div><div class="flip-back"><h3>ROOT</h3><p>Access Granted</p></div></div></div>
        <div class="gallery-col"><div class="flip-card-inner"><div class="flip-front"><img src="https://i.ibb.co/wNQRqcLf/pexels-cjanimus-20261506.jpg"></div><div class="flip-back"><h3>SMART</h3><p>Irrigation</p></div></div></div>
        <div class="gallery-col"><div class="flip-card-inner"><div class="flip-front"><img src="https://i.ibb.co/Lzhj4fyG/pexels-doma-18248912.jpg"></div><div class="flip-back"><h3>ACTIVE</h3><p>Monitoring</p></div></div></div>
        <div class="gallery-col"><div class="flip-card-inner"><div class="flip-front"><img src="https://i.ibb.co/5gWj605y/pexels-elias-tigiser-411757-5652089.jpg"></div><div class="flip-back"><h3>DATA</h3><p>Spectral</p></div></div></div>
        <div class="gallery-col"><div class="flip-card-inner"><div class="flip-front"><img src="https://i.ibb.co/k2yVDmbh/pexels-mikhail-nilov-6965514.jpg"></div><div class="flip-back"><h3>CORE</h3><p>v2.0.4</p></div></div></div>
        <div class="gallery-col"><div class="flip-card-inner"><div class="flip-front"><img src="https://i.ibb.co/MD432Gtx/pexels-alexander-hohn-2153656687-33217919.jpg"></div><div class="flip-back"><h3>NODE</h3><p>Connected</p></div></div></div>
    </div>

    <script>
        const SB_URL = "https://ccvtugkkhweprgtupwqb.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNjdnR1Z2traHdlcHJndHVwd3FiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzOTcyMjAsImV4cCI6MjA4NTk3MzIyMH0.zZ_5Dx8txWOFfrYj0QIKu3v5Pp4Q7EMYdHGzxUalcQ4";
        const _supabase = supabase.createClient(SB_URL, SB_KEY);
        let isSignUpMode = false;

        function lockSidebar(shouldLock) {
            const sidebar = document.getElementById('main-sidebar');
            if (shouldLock) sidebar.classList.add('locked');
            else {
                setTimeout(() => {
                    if (!document.activeElement.id.includes('email') && !document.activeElement.id.includes('password')) {
                        sidebar.classList.remove('locked');
                    }
                }, 150);
            }
        }

        function toggleAuthMode() {
            isSignUpMode = !isSignUpMode;
            document.getElementById('auth-title').innerText = isSignUpMode ? "CREATE_USER" : "LOGIN";
        }

        async function handleAuth() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            let result = isSignUpMode ? await _supabase.auth.signUp({ email, password }) : await _supabase.auth.signInWithPassword({ email, password });
            if (result.error) alert(result.error.message); 
            else if (isSignUpMode) alert("Account Created."); 
            else showUI(result.data.user);
        }

        function showUI(user) {
            document.getElementById('auth-box').classList.add('hidden');
            document.getElementById('signup-nav').classList.add('hidden');
            document.getElementById('user-display-name').innerText = user.email.split('@')[0].toUpperCase();
            document.getElementById('user-display-email').innerText = user.email;

            const sidebar = document.getElementById('main-sidebar');
            const dashSide = document.getElementById('dash-side-content');

            if (window.innerWidth <= 768) {
                sidebar.style.display = 'none';
                document.body.appendChild(dashSide);
                dashSide.classList.add('active-mobile-bar');
            } else {
                sidebar.classList.add('active-dash');
                sidebar.classList.add('locked');
                dashSide.style.display = 'block';
            }

            document.getElementById('gallery').classList.add('blurred');
            document.getElementById('hardware-hub').classList.add('active');
            loadDevices();
        }

        async function registerDevice() {
            const mac = document.getElementById('mac-address').value;
            if(!mac) return;
            const { data: { user } } = await _supabase.auth.getUser();
            const { error } = await _supabase.from('devices').insert([{ device_id: mac, owner_id: user.id, active_seed_id: 1 }]);
            if (!error) { document.getElementById('mac-address').value = ""; loadDevices(); }
        }

        async function loadDevices() {
            const { data } = await _supabase.from('devices').select('*');
            if (data) {
                document.getElementById('device-list').innerHTML = data.map(d => `
                    <div class="device-item">
                        <span>NODE: ${d.device_id}</span>
                        <span style="color:var(--primary-green)">${d.current_moisture || 0}% RH</span>
                    </div>
                `).join('');
            }
        }
    </script>
</body>
</html>
